# 操作系统导论

## 参考资料

- 操作系统导论

## 操作系统介绍

- 下详叙

## 虚拟化

### CPU 虚拟化

- 通过时分共享实现

#### 进程

- 进程是程序的一次执行实例, 拥有独立的地址空间, 寄存器状态, 以及其他资源
- 系统会维护一个进程表, 记录所有进程的信息
- 状态
    - 初始
    - 运行
    - 就绪
    - 阻塞
    - 最终 (僵尸进程, 用于让父亲进程获取子进程的退出状态)
- 创建
    - 在进程表中分配一个新条目
    - 惰性加载程序的代码段和数据段
    - 分配并初始化运行时栈区与堆区
    - 初始化资源, 如标准输入输出的文件描述符
    - 清楚寄存器
    - 转移控制权
- 销毁
- 等待
- 其他控制

#### 进程 API

- `fork()`
    - 复制当前进程为子进程, 父子都从该调用返回继续执行
    - 子进程返回 0, 父进程返回子进程 ID
- `wait()`
    - 阻塞当前进程, 直到某个子进程退出
    - 返回退出的子进程 ID
- `exec()`
    - 用一个新程序替换当前进程的代码段和数据段
    - 重新初始化堆区和栈区
- 如此奇怪的设计是为了方便在 `fork()` 与 `exec()` 之间插入其他操作, 如重定向标准输入输出

#### 受限直接执行

- 为了提高性能, 允许用户进程直接在 CPU 上运行, 但还是要受限于某些规则
- 区分用户态与内核态
- 提供陷入与从陷阱返回的硬件原语
    - 在每个进程的内核栈中保存现场
    - 内核在启动时设置陷阱表

#### 进程间切换

- 系统可以等待任意系统调用, 或者用户程序进行非法操作
    - `yield()` 什么也不做, 只是让出 CPU
- 也可以通过时钟中断, 时钟中断也就是为了操作系统维护控制权而设计的
    - 由操作系统启动时钟
    - 触发时会调用内核中的时钟中断处理程序
- 上下文切换
    - 和保存现场类似但不一样
    - 是由操作系统主导的存储在进程结构中的现场保存与恢复

#### 进程调度

- 越了解工作负载, 越能设计出好的调度算法
- $\text{周转时间} = \text{完成时间} - \text{到达时间}$ 性能指标
    - 性能和公平在调度中往往是矛盾的
- FIFO
    - 先到先工作
    - 出现长作业时, 短作业等待时间过长 (护航效应)
- SFJ 最短作业优先
    - 优先调度估计运行时间最短的作业
    - 需要预知作业运行时间, 实际中难以实现
- 现在考虑任务不同时间到达
- STCF 最短完成时间优先
    - 抢占式的 SJF
    - 新到达的短作业可以抢占正在运行的长作业
- $\text{响应时间} = \text{第一次运行时间} - \text{到达时间}$ 交互式系统重要指标
- RR 时间片轮转
    - 每个进程分配一个时间片, 时间片用完后切换到下一个进程
    - 时间片过大接近 FIFO, 过小则切换开销过大
    - 但对于周转时间非常差
- 现在考虑 IO 与运行时间不可知
- MLFQ 多级反馈队列
    - 基本思想
        - IO 密集型进程提升优先级, CPU 密集型进程降低优先级
        - 多个就绪队列, 每个队列有不同优先级, 队列内的进程优先级相同
        - 优先级高的队列先调度, 队列中进程采用 RR 调度
    - 方案
        - 新到达的进程进入最高优先级队列
        - 时间片用完后降低优先级, 但若在时间片内主动释放 CPU 则保持优先级
    - 对于 IO 密集型进程太友好, 可能导致 CPU 密集型进程饥饿
        - 每过一段时间, 将所有进程提升到最高优先级队列 (核心问题是具体多长时间)
    - 但是仍然会被恶意进程欺骗
        - 例如一个进程不断地在时间片内释放 CPU, 永远保持最高优先级
        - 解决方法是主动释放 CPU 不重置时间片
- 如果我们不考虑周转时间与响应时间, 而是确保每个工作获得一定比例的 CPU 时间
- 彩票调度
    - 每个进程根据彩票数量获得相应比例调度概率
    - 每次调度时, 系统随机抽取彩票, 持有该彩票的进程获得 CPU 时间
    - 彩票货币
        - 用户分配给进程彩票, 系统自动根据全局彩票池调度
    - 彩票转让
        - 进程可以将彩票转让给其他进程 (我依赖你, 我给你彩票)
    - 彩票通胀
        - 进程相互信任时, 可临时自发行彩票
    - 彩票中奖是随机的, 若为了公平性, 可引入行程, 使用步长调度
        - 用一个大数处以每个进程的彩票数, 结果作为该进程的步长
        - 每次调度一个进程时, 将该进程的行程加上步长
        - 每次调度时选择行程最小的进程

#### 多处理器调度

### 内存虚拟化

## 并发控制

## 持久化
